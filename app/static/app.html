<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Longevity Alchemist Workspace</title>
    <style>
      :root {
        --bg: #eef2f7;
        --panel: #ffffff;
        --ink: #1b2533;
        --muted: #5f7082;
        --accent: #0a78b8;
        --accent2: #065f92;
        --ok: #1f845a;
        --warn: #ad5f00;
        --error: #c9372c;
        --border: #d9e4ee;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Segoe UI", "Helvetica Neue", sans-serif;
        color: var(--ink);
        background: radial-gradient(circle at 10% 10%, #f9fbff, var(--bg) 35%);
      }
      .shell { max-width: 960px; margin: 0 auto; padding: 1rem; }
      .topbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        margin-bottom: .8rem;
      }
      .title { margin: 0; font-size: clamp(1.1rem, 2vw, 1.8rem); }
      .muted { margin: .2rem 0 0; color: var(--muted); font-size: .9rem; }
      button {
        border: none;
        border-radius: 9px;
        padding: .6rem .75rem;
        font-weight: 600;
        cursor: pointer;
      }
      .top-actions { display: flex; gap: .5rem; align-items: center; }
      .hamburger {
        position: relative;
        width: 2.5rem;
        height: 2.5rem;
        border: 1px solid var(--border);
        background: #f0f6fb;
        color: #234964;
        border-radius: 10px;
      }
      .hamburger .icon-bars {
        width: 16px;
        height: 12px;
        display: inline-block;
        background:
          linear-gradient(#234964, #234964) 0 0 / 16px 2px no-repeat,
          linear-gradient(#234964, #234964) 0 5px / 16px 2px no-repeat,
          linear-gradient(#234964, #234964) 0 10px / 16px 2px no-repeat;
      }
      .alert-dot {
        position: absolute;
        top: 3px;
        right: 3px;
        width: 9px;
        height: 9px;
        border-radius: 50%;
        background: #d92b2b;
        border: 1px solid #ffffff;
        display: none;
      }
      .alert-dot.show { display: block; }
      .logout { background: #f0f4f8; color: #27425b; border: 1px solid var(--border); }
      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(9, 24, 37, .22);
        opacity: 0;
        pointer-events: none;
        transition: opacity .2s ease;
        z-index: 20;
      }
      .overlay.open {
        opacity: 1;
        pointer-events: auto;
      }
      .drawer {
        position: fixed;
        top: 0;
        right: -320px;
        width: min(320px, 85vw);
        height: 100vh;
        background: linear-gradient(180deg, #f8fcff, #edf4fa);
        border-left: 1px solid var(--border);
        box-shadow: -14px 0 28px rgba(13, 34, 52, .18);
        padding: .9rem;
        z-index: 30;
        transition: right .22s ease;
      }
      .drawer.open { right: 0; }
      .drawer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: .7rem;
      }
      .drawer-title {
        margin: 0;
        font-size: .98rem;
        color: #244862;
      }
      .close-drawer {
        width: 2rem;
        height: 2rem;
        border: 1px solid var(--border);
        background: #f7fbff;
        color: #335a76;
      }
      .drawer-nav {
        display: grid;
        gap: .5rem;
      }
      .nav-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        border: 1px solid #c9dcec;
        background: #e8f2fb;
        color: #1f4b67;
        border-radius: 10px;
        padding: .6rem .7rem;
      }
      .nav-item.active {
        background: #d4e9f8;
        border-color: #9dc8e4;
      }
      .card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: 0 6px 18px rgba(15, 42, 66, .08);
        padding: .95rem;
      }
      .view { display: none; }
      .view.active { display: block; }
      .section-title { margin: .1rem 0 .35rem; font-size: 1rem; }
      .field { display: grid; gap: .35rem; margin-bottom: .7rem; }
      label { font-size: .85rem; color: #405469; }
      input, select, textarea {
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: .6rem .65rem;
        font-size: .95rem;
      }
      textarea { min-height: 115px; resize: vertical; }
      .row { display: flex; gap: .5rem; }
      .row > * { flex: 1; }
      .chat-toolbar {
        display: flex;
        gap: .5rem;
        align-items: flex-end;
        margin-bottom: .45rem;
      }
      .chat-toolbar .field { margin-bottom: 0; }
      .mode-wrap {
        position: relative;
        min-width: 220px;
      }
      .mode-button {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--border);
        background: #f4f8fc;
        color: #213f57;
        padding: .58rem .65rem;
      }
      .mode-button .caret {
        font-size: .72rem;
        opacity: .8;
      }
      .mode-panel {
        position: absolute;
        right: 0;
        top: calc(100% + 6px);
        z-index: 5;
        width: min(320px, 82vw);
        border: 1px solid var(--border);
        border-radius: 12px;
        background: #ffffff;
        box-shadow: 0 12px 24px rgba(21, 45, 66, .16);
        padding: .35rem;
      }
      .mode-panel[hidden] { display: none; }
      .mode-option {
        width: 100%;
        border: 1px solid transparent;
        border-radius: 10px;
        background: transparent;
        text-align: left;
        color: #1f364b;
        padding: .5rem .55rem;
        margin: .08rem 0;
      }
      .mode-option:hover {
        border-color: #c9dced;
        background: #f2f8fd;
      }
      .mode-option.active {
        border-color: #98c0de;
        background: #e8f3fc;
      }
      .mode-option .line1 {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 700;
      }
      .mode-option .line2 {
        color: var(--muted);
        font-size: .82rem;
        margin-top: .1rem;
      }
      .mode-check {
        color: #1f845a;
        font-size: .85rem;
      }
      .btn-primary { background: var(--accent); color: #fff; }
      .btn-primary:hover { background: var(--accent2); }
      .btn-ghost { background: #f3f6fa; color: #24384f; border: 1px solid var(--border); }
      .notice { min-height: 1.2rem; font-size: .86rem; margin-top: .25rem; color: var(--muted); }
      .notice.ok { color: var(--ok); }
      .notice.warn { color: var(--warn); }
      .notice.error { color: var(--error); }
      .status {
        display: inline-flex;
        align-items: center;
        gap: .4rem;
        font-size: .82rem;
        padding: .2rem .45rem;
        border-radius: 999px;
        border: 1px solid #bfd6e8;
        background: #ecf5fb;
        color: #275372;
      }
      .status.ok { border-color: #b8decb; background: #e9f8ef; color: #1f6848; }
      .status.warn { border-color: #e1d0b1; background: #fdf5e8; color: #8b5310; }
      .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: .65rem; }
      .chat-answer {
        margin-top: .8rem;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #f8fbff;
        padding: .7rem;
      }
      .chat-answer h1, .chat-answer h2, .chat-answer h3, .chat-answer h4 {
        margin: .55rem 0 .35rem;
      }
      .chat-answer p { margin: .45rem 0; line-height: 1.5; }
      .chat-answer ul { margin: .25rem 0 .5rem 1.1rem; }
      .chat-answer li { margin: .2rem 0; }
      .chat-log {
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #f8fbff;
        min-height: 180px;
        max-height: 360px;
        overflow-y: auto;
        padding: .6rem;
      }
      .bubble {
        max-width: 85%;
        margin: .35rem 0;
        padding: .5rem .65rem;
        border-radius: 10px;
        line-height: 1.35;
        font-size: .9rem;
      }
      .bubble.coach {
        background: #e7f1fb;
        color: #204a66;
        border: 1px solid #c8deef;
      }
      .bubble.user {
        margin-left: auto;
        background: #dff3e8;
        color: #1f5f41;
        border: 1px solid #bde0cd;
      }
      .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: .4rem;
      }
      .table th, .table td {
        border-bottom: 1px solid #e7edf4;
        padding: .45rem;
        text-align: left;
        font-size: .86rem;
      }
      .hint { font-size: .84rem; color: var(--muted); margin-top: .3rem; }
      @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <div class="shell">
      <div class="topbar">
        <div>
          <h1 class="title">Longevity Workspace</h1>
          <p class="muted" id="welcome">Loading session...</p>
        </div>
        <div class="top-actions">
          <button class="hamburger" id="menu-toggle" aria-label="Open menu">
            <span class="icon-bars" aria-hidden="true"></span>
            <span class="alert-dot" id="intake-alert-dot" aria-hidden="true"></span>
          </button>
          <button class="logout" id="logout">Log Out</button>
        </div>
      </div>
      <div class="overlay" id="menu-overlay"></div>
      <aside class="drawer" id="menu-drawer">
        <div class="drawer-header">
          <h3 class="drawer-title">Workspace Menu</h3>
          <button class="close-drawer" id="menu-close" aria-label="Close menu">x</button>
        </div>
        <div class="drawer-nav">
          <button id="menu-chat" class="nav-item active"><span>Chat</span></button>
          <button id="menu-intake" class="nav-item"><span>Intake</span><span id="intake-badge" class="status warn">pending</span></button>
          <button id="menu-settings" class="nav-item"><span>Settings</span></button>
          <button id="menu-usage" class="nav-item"><span>Model Usage</span></button>
        </div>
      </aside>

      <section class="card">
        <article id="view-chat" class="view active">
          <h2 class="section-title">Default Chat</h2>
          <p class="muted">Ask a coaching question anytime. Mode controls response depth: Quick is faster, Deep is more thorough.</p>
          <div class="field"><label for="chat-question">Question</label><textarea id="chat-question" placeholder="How can I improve energy this week?"></textarea></div>
          <div class="chat-toolbar">
            <div class="field">
              <label>Mode</label>
              <div class="mode-wrap">
                <button class="mode-button" id="chat-mode-button" aria-haspopup="true" aria-expanded="false" type="button">
                  <span id="chat-mode-label">Auto</span>
                  <span class="caret">v</span>
                </button>
                <div class="mode-panel" id="chat-mode-panel" hidden>
                  <button class="mode-option active" type="button" data-mode="auto">
                    <span class="line1">Auto <span class="mode-check">✓</span></span>
                    <span class="line2">Chooses Quick or Deep from question complexity.</span>
                  </button>
                  <button class="mode-option" type="button" data-mode="quick">
                    <span class="line1">Quick <span class="mode-check" hidden>✓</span></span>
                    <span class="line2">Faster response with concise analysis.</span>
                  </button>
                  <button class="mode-option" type="button" data-mode="deep">
                    <span class="line1">Deep <span class="mode-check" hidden>✓</span></span>
                    <span class="line2">Uses Deep Thinker for broader reasoning.</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <button class="btn-primary" id="chat-send">Send</button>
            <button class="btn-ghost" id="chat-clear">Clear</button>
          </div>
          <div class="notice" id="chat-notice"></div>
          <div id="chat-answer" class="chat-answer" style="display:none;"></div>
        </article>

        <article id="view-intake" class="view">
          <h2 class="section-title">Intake Coach</h2>
          <p class="muted">Complete intake through a guided coach chat. Answer naturally with your preferred units (lb/kg, in/cm, etc.).</p>
          <div class="notice" id="intake-status"></div>
          <div class="field">
            <label for="intake-top-goals">Top Goals (optional starter)</label>
            <input id="intake-top-goals" type="text" placeholder="energy, sleep, weight loss" />
          </div>
          <div class="row">
            <button class="btn-primary" id="intake-start">Start / Resume Intake Coach</button>
            <button class="btn-ghost" id="intake-refresh">Refresh Status</button>
          </div>
          <div class="field"><label>Coach Chat</label><div id="intake-chat-log" class="chat-log"></div></div>
          <div class="field">
            <label for="intake-answer">Your Answer</label>
            <textarea id="intake-answer" placeholder="Type answer for current intake question"></textarea>
          </div>
          <div class="row">
            <button class="btn-primary" id="intake-answer-send">Send Answer</button>
            <button class="btn-ghost" id="intake-complete" style="display:none;">Finalize Intake</button>
          </div>
          <div class="notice" id="intake-notice"></div>
        </article>

        <article id="view-settings" class="view">
          <h2 class="section-title">Settings</h2>
          <p class="muted">Update AI settings or change password from this menu at any time.</p>
          <p class="hint">Model pricing shown here uses provider list rates (OpenAI API Pricing and Gemini API Pricing), last synced on February 15, 2026.</p>
          <div class="grid-2">
            <div>
              <h3 class="section-title">AI Settings</h3>
              <div class="field"><label for="provider">Provider</label><select id="provider"><option value="">Select provider</option><option value="openai">OpenAI (ChatGPT)</option><option value="gemini">Gemini</option></select></div>
              <div class="field"><label for="api-key">API Key</label><input id="api-key" type="password" placeholder="Required for first-time setup" /><div class="hint" id="api-key-mask"></div></div>
              <div class="field"><label for="deep-model">Deep Thinker Model</label><select id="deep-model"><option value="">Select model</option></select></div>
              <div class="field"><label for="reason-model">Reasoning Model</label><select id="reason-model"><option value="">Select model</option></select></div>
              <div class="field"><label for="utility-model">Utility Model</label><select id="utility-model"><option value="">Select model</option></select></div>
              <div class="row"><button class="btn-primary" id="ai-save">Save AI Settings</button><button class="btn-ghost" id="ai-load">Load Current</button></div>
              <div class="notice" id="ai-notice"></div>
            </div>
            <div>
              <h3 class="section-title">Password</h3>
              <div class="field"><label for="current-password">Current Password</label><input id="current-password" type="password" /></div>
              <div class="field"><label for="new-password">New Password</label><input id="new-password" type="password" /></div>
              <button class="btn-primary" id="password-save">Change Password</button>
              <div class="notice" id="password-notice"></div>
            </div>
          </div>
        </article>

        <article id="view-usage" class="view">
          <h2 class="section-title">Model Token Usage</h2>
          <p class="muted">Token usage is tracked per user/provider/model for visibility and cost control.</p>
          <button class="btn-ghost" id="usage-refresh">Refresh</button>
          <table class="table" id="usage-table">
            <thead><tr><th>Provider</th><th>Model</th><th>Requests</th><th>Prompt</th><th>Completion</th><th>Total</th><th>Rough Cost (USD)</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="hint" id="usage-hint"></div>
        </article>
      </section>
    </div>

    <script>
      const token = sessionStorage.getItem("access_token") || "";
      if (!token) window.location.href = "/onboarding";

      const el = (id) => document.getElementById(id);
      const views = ["chat", "intake", "settings", "usage"];
      const intakeState = { sessionId: null, readyToComplete: false };
      const intakeChat = [];
      const CHAT_MODE_PRESETS = {
        auto: { label: "Auto", mode: "quick", deepThink: false },
        quick: { label: "Quick", mode: "quick", deepThink: false },
        deep: { label: "Deep", mode: "deep", deepThink: true }
      };
      let selectedChatMode = "auto";

      function authHeaders() {
        return { "Authorization": "Bearer " + token, "Content-Type": "application/json" };
      }

      function setNotice(id, text, kind) {
        const node = el(id);
        node.textContent = text || "";
        node.className = "notice" + (kind ? " " + kind : "");
      }

      function escapeHtml(value) {
        return String(value || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function renderSimpleMarkdown(markdownText) {
        const src = String(markdownText || "").replace(/\r\n/g, "\n");
        const lines = src.split("\n");
        let html = "";
        let inList = false;
        for (const rawLine of lines) {
          const line = rawLine.trimEnd();
          if (!line.trim()) {
            if (inList) {
              html += "</ul>";
              inList = false;
            }
            continue;
          }
          const hMatch = line.match(/^(#{1,4})\s+(.*)$/);
          if (hMatch) {
            if (inList) {
              html += "</ul>";
              inList = false;
            }
            const level = Math.min(4, hMatch[1].length);
            let content = escapeHtml(hMatch[2]);
            content = content.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
            html += "<h" + level + ">" + content + "</h" + level + ">";
            continue;
          }
          const liMatch = line.match(/^[-*]\s+(.*)$/);
          if (liMatch) {
            if (!inList) {
              html += "<ul>";
              inList = true;
            }
            let item = escapeHtml(liMatch[1]);
            item = item.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
            html += "<li>" + item + "</li>";
            continue;
          }
          if (inList) {
            html += "</ul>";
            inList = false;
          }
          let paragraph = escapeHtml(line);
          paragraph = paragraph.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
          paragraph = paragraph.replace(/`([^`]+?)`/g, "<code>$1</code>");
          html += "<p>" + paragraph + "</p>";
        }
        if (inList) html += "</ul>";
        return html || "<p>No answer content.</p>";
      }

      function addIntakeChatMessage(role, text) {
        if (!text) return;
        intakeChat.push({ role, text });
        const log = el("intake-chat-log");
        const bubble = document.createElement("div");
        bubble.className = "bubble " + role;
        bubble.textContent = text;
        log.appendChild(bubble);
        log.scrollTop = log.scrollHeight;
      }

      function showView(name) {
        views.forEach((v) => {
          el("view-" + v).classList.toggle("active", v === name);
          el("menu-" + v).classList.toggle("active", v === name);
        });
        closeDrawer();
      }

      function openDrawer() {
        el("menu-drawer").classList.add("open");
        el("menu-overlay").classList.add("open");
      }

      function closeDrawer() {
        el("menu-drawer").classList.remove("open");
        el("menu-overlay").classList.remove("open");
      }

      function toggleDrawer() {
        if (el("menu-drawer").classList.contains("open")) {
          closeDrawer();
        } else {
          openDrawer();
        }
      }

      function openModePanel() {
        el("chat-mode-panel").hidden = false;
        el("chat-mode-button").setAttribute("aria-expanded", "true");
      }

      function closeModePanel() {
        el("chat-mode-panel").hidden = true;
        el("chat-mode-button").setAttribute("aria-expanded", "false");
      }

      function toggleModePanel() {
        if (el("chat-mode-panel").hidden) openModePanel();
        else closeModePanel();
      }

      function applyModeSelection(modeKey) {
        selectedChatMode = CHAT_MODE_PRESETS[modeKey] ? modeKey : "auto";
        el("chat-mode-label").textContent = CHAT_MODE_PRESETS[selectedChatMode].label;
        document.querySelectorAll(".mode-option").forEach((node) => {
          const active = node.getAttribute("data-mode") === selectedChatMode;
          node.classList.toggle("active", active);
          const check = node.querySelector(".mode-check");
          if (check) check.hidden = !active;
        });
        closeModePanel();
      }

      function resolveChatMode(question) {
        if (selectedChatMode !== "auto") return CHAT_MODE_PRESETS[selectedChatMode];
        // Cost guardrail: default auto mode always runs quick path.
        return CHAT_MODE_PRESETS.quick;
      }

      async function loadSession() {
        const res = await fetch("/auth/session", { headers: { "Authorization": "Bearer " + token } });
        if (!res.ok) {
          sessionStorage.removeItem("access_token");
          window.location.href = "/onboarding";
          return;
        }
        const body = await res.json();
        el("welcome").textContent = "Signed in as " + body.email;
      }

      function modelLabel(entry) {
        if (!entry.cost_known) return entry.model + " (cost n/a)";
        return entry.model + " ($" + Number(entry.input_cost_per_1m_usd).toFixed(2) + "/$" + Number(entry.output_cost_per_1m_usd).toFixed(2) + " per 1M)";
      }

      function renderModels(selectId, options, selected) {
        const node = el(selectId);
        node.innerHTML = '<option value="">Select model</option>';
        options.forEach((entry) => {
          const opt = document.createElement("option");
          opt.value = entry.model;
          opt.textContent = modelLabel(entry);
          node.appendChild(opt);
        });
        if (selected) node.value = selected;
      }

      async function loadModelOptions() {
        const provider = el("provider").value;
        const apiKey = el("api-key").value.trim();
        if (!provider || !apiKey) return;
        setNotice("ai-notice", "Validating key and loading models...", "");
        const res = await fetch("/auth/model-options", {
          method: "POST",
          headers: authHeaders(),
          body: JSON.stringify({ ai_provider: provider, ai_api_key: apiKey })
        });
        if (!res.ok) {
          setNotice("ai-notice", "Could not validate key/models.", "error");
          return;
        }
        const body = await res.json();
        if (body.source !== "provider_api") {
          setNotice("ai-notice", "Provider key validation failed.", "error");
          return;
        }
        const opts = Array.isArray(body.model_options) ? body.model_options : [];
        renderModels("deep-model", opts, body.default_deep_thinker_model);
        renderModels("reason-model", opts, body.default_reasoning_model);
        renderModels("utility-model", opts, body.default_utility_model);
        setNotice("ai-notice", "Model catalog loaded.", "ok");
      }

      async function loadAiConfig() {
        const res = await fetch("/auth/ai-config", { headers: { "Authorization": "Bearer " + token } });
        if (!res.ok) {
          el("api-key").placeholder = "Required for first-time setup";
          el("api-key-mask").textContent = "";
          setNotice("ai-notice", "AI config not set yet.", "warn");
          return;
        }
        const body = await res.json();
        el("provider").value = body.ai_provider || "";
        renderModels("deep-model", [], body.ai_deep_thinker_model);
        renderModels("reason-model", [], body.ai_reasoning_model);
        renderModels("utility-model", [], body.ai_utility_model);
        el("api-key").value = "";
        el("api-key").placeholder = "Leave blank to keep existing key";
        el("api-key-mask").textContent = body.api_key_masked
          ? ("Saved key: " + body.api_key_masked)
          : "";
        setNotice("ai-notice", "Loaded current AI config. Enter a new API key only if you want to replace it.", "warn");
      }

      async function saveAiConfig() {
        const payload = {
          ai_provider: el("provider").value,
          ai_deep_thinker_model: el("deep-model").value,
          ai_reasoning_model: el("reason-model").value,
          ai_utility_model: el("utility-model").value,
          ai_api_key: el("api-key").value.trim()
        };
        if (!payload.ai_provider || !payload.ai_deep_thinker_model || !payload.ai_reasoning_model || !payload.ai_utility_model) {
          setNotice("ai-notice", "Provider and all three model slots are required.", "error");
          return;
        }
        const res = await fetch("/auth/ai-config", {
          method: "PUT",
          headers: authHeaders(),
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          setNotice("ai-notice", "Could not save AI settings.", "error");
          return;
        }
        const body = await res.json().catch(() => ({}));
        el("api-key").value = "";
        if (body.api_key_masked) {
          el("api-key-mask").textContent = "Saved key: " + body.api_key_masked;
        }
        setNotice("ai-notice", "AI settings updated.", "ok");
      }

      async function loadIntakeStatus() {
        const res = await fetch("/intake/status", { headers: { "Authorization": "Bearer " + token } });
        if (!res.ok) {
          setNotice("intake-status", "Could not load intake status.", "error");
          return;
        }
        const body = await res.json();
        if (body.baseline_completed) {
          el("intake-badge").textContent = "completed";
          el("intake-badge").className = "status ok";
          el("intake-alert-dot").classList.remove("show");
          setNotice("intake-status", "Intake completed. You can update it anytime from this menu.", "ok");
        } else {
          el("intake-badge").textContent = "pending";
          el("intake-badge").className = "status warn";
          el("intake-alert-dot").classList.add("show");
          setNotice("intake-status", "Intake not completed yet. You can skip for now and run later from this menu.", "warn");
        }
      }

      function renderCoachState(payload) {
        intakeState.sessionId = payload.session_id;
        intakeState.readyToComplete = !!payload.ready_to_complete;
        const question = (payload.coach_message || "").trim();
        if (question) addIntakeChatMessage("coach", question);
        el("intake-complete").style.display = intakeState.readyToComplete ? "inline-block" : "none";
      }

      async function startIntakeConversation() {
        const topGoalsRaw = el("intake-top-goals").value.trim();
        const goals = topGoalsRaw
          ? topGoalsRaw.split(",").map((g) => g.trim()).filter((g) => g).slice(0, 3)
          : [];
        setNotice("intake-notice", "Starting intake coach...", "");
        const res = await fetch("/intake/conversation/start", {
          method: "POST",
          headers: authHeaders(),
          body: JSON.stringify({ top_goals: goals.length ? goals : null })
        });
        if (!res.ok) {
          const body = await res.json().catch(() => ({}));
          setNotice("intake-notice", body.detail || "Could not start intake coach.", "error");
          return;
        }
        el("intake-chat-log").innerHTML = "";
        intakeChat.length = 0;
        renderCoachState(await res.json());
        setNotice("intake-notice", "Coach started. Answer the current question.", "ok");
      }

      async function sendIntakeAnswer() {
        const answer = el("intake-answer").value.trim();
        if (!intakeState.sessionId) {
          setNotice("intake-notice", "Start intake coach first.", "warn");
          return;
        }
        if (!answer) {
          setNotice("intake-notice", "Enter an answer first.", "error");
          return;
        }
        addIntakeChatMessage("user", answer);
        setNotice("intake-notice", "Sending answer...", "");
        const res = await fetch("/intake/conversation/answer", {
          method: "POST",
          headers: authHeaders(),
          body: JSON.stringify({ session_id: intakeState.sessionId, answer })
        });
        if (!res.ok) {
          const body = await res.json().catch(() => ({}));
          setNotice("intake-notice", body.detail || "Could not submit answer.", "error");
          return;
        }
        el("intake-answer").value = "";
        renderCoachState(await res.json());
        setNotice("intake-notice", intakeState.readyToComplete ? "Ready to finalize intake." : "Answer recorded. Next question loaded.", "ok");
      }

      async function finalizeIntakeConversation() {
        if (!intakeState.sessionId) {
          setNotice("intake-notice", "Start intake coach first.", "warn");
          return;
        }
        setNotice("intake-notice", "Finalizing intake...", "");
        const res = await fetch("/intake/conversation/complete", {
          method: "POST",
          headers: authHeaders(),
          body: JSON.stringify({ session_id: intakeState.sessionId })
        });
        if (!res.ok) {
          const body = await res.json().catch(() => ({}));
          setNotice("intake-notice", body.detail || "Could not finalize intake.", "error");
          return;
        }
        intakeState.readyToComplete = false;
        el("intake-complete").style.display = "none";
        setNotice("intake-notice", "Intake complete. Redirecting to default chat.", "ok");
        await loadIntakeStatus();
        showView("chat");
      }

      async function sendChat() {
        const question = el("chat-question").value.trim();
        if (!question) {
          setNotice("chat-notice", "Enter a question first.", "error");
          return;
        }
        const resolved = resolveChatMode(question);
        const stageMessages = [
          "Reviewing your goals and recent context...",
          "Running specialist coaching agents...",
          "Synthesizing a final coaching response..."
        ];
        let stageIdx = 0;
        setNotice("chat-notice", stageMessages[stageIdx], "");
        const noticeTimer = setInterval(() => {
          stageIdx = (stageIdx + 1) % stageMessages.length;
          setNotice("chat-notice", stageMessages[stageIdx], "");
        }, 1300);
        const res = await fetch("/coach/question", {
          method: "POST",
          headers: authHeaders(),
          body: JSON.stringify({
            question,
            mode: resolved.mode,
            deep_think: resolved.deepThink
          })
        });
        clearInterval(noticeTimer);
        if (!res.ok) {
          setNotice("chat-notice", "Chat request failed.", "error");
          return;
        }
        const body = await res.json();
        const out = el("chat-answer");
        out.style.display = "block";
        out.innerHTML = "<h3>Answer</h3>" + renderSimpleMarkdown(body.answer || "")
          + "<strong>Coach Follow-up Questions (Please answer next)</strong><ul>" + (body.suggested_questions || []).map((q) => "<li>" + q + "</li>").join("") + "</ul>"
          + "<p><em>Reply with your answers in your next message so guidance can be tailored and recorded.</em></p>";
        const flags = Array.isArray(body.safety_flags) ? body.safety_flags : [];
        const llmFailure = flags.some((f) => String(f).startsWith("llm_"));
        if (llmFailure) {
          if (flags.includes("llm_rate_limited")) {
            setNotice("chat-notice", "AI provider rate limit/quota reached. Returned practical fallback guidance.", "warn");
          } else if (flags.includes("llm_unavailable") || flags.includes("llm_provider_error")) {
            setNotice("chat-notice", "AI service timed out or is temporarily unavailable. Returned practical fallback guidance.", "warn");
          } else if (flags.includes("llm_auth_error") || flags.includes("llm_model_not_found")) {
            setNotice("chat-notice", "AI configuration issue detected. Check Settings and model selection.", "error");
          } else {
            setNotice("chat-notice", "AI provider/model error. Check Settings (provider, key, and model selections).", "error");
          }
        } else {
          setNotice("chat-notice", "Response ready (" + resolved.label + " mode).", "ok");
        }
      }

      async function changePassword() {
        const payload = {
          current_password: el("current-password").value,
          new_password: el("new-password").value
        };
        if (!payload.current_password || !payload.new_password) {
          setNotice("password-notice", "Current and new password are required.", "error");
          return;
        }
        const res = await fetch("/auth/change-password", {
          method: "PUT",
          headers: authHeaders(),
          body: JSON.stringify(payload)
        });
        if (res.status === 204) {
          el("current-password").value = "";
          el("new-password").value = "";
          setNotice("password-notice", "Password updated.", "ok");
          return;
        }
        const body = await res.json().catch(() => ({}));
        setNotice("password-notice", body.detail || "Password update failed.", "error");
      }

      async function loadUsage() {
        const res = await fetch("/auth/model-usage", { headers: { "Authorization": "Bearer " + token } });
        if (!res.ok) {
          el("usage-hint").textContent = "Could not load usage.";
          return;
        }
        const body = await res.json();
        const tbody = el("usage-table").querySelector("tbody");
        tbody.innerHTML = "";
        const items = body.items || [];
        if (!items.length) {
          el("usage-hint").textContent = "No model usage yet. Ask a chat question to generate usage.";
          return;
        }
        items.forEach((item) => {
          const tr = document.createElement("tr");
          let roughCost = "n/a";
          if (typeof item.rough_cost_usd === "number" && Number.isFinite(item.rough_cost_usd)) {
            roughCost = "$" + Number(item.rough_cost_usd).toFixed(4);
          }
          tr.innerHTML = "<td>" + item.provider + "</td><td>" + item.model + "</td><td>" + item.request_count + "</td><td>" + item.prompt_tokens + "</td><td>" + item.completion_tokens + "</td><td>" + item.total_tokens + "</td><td>" + roughCost + "</td>";
          tbody.appendChild(tr);
        });
        el("usage-hint").textContent = "Rows are aggregated by provider/model for your account. Rough cost is estimated from known per-1M token pricing.";
      }

      el("menu-chat").addEventListener("click", () => showView("chat"));
      el("menu-intake").addEventListener("click", () => showView("intake"));
      el("menu-settings").addEventListener("click", () => showView("settings"));
      el("menu-usage").addEventListener("click", async () => { showView("usage"); await loadUsage(); });
      el("logout").addEventListener("click", () => { sessionStorage.removeItem("access_token"); window.location.href = "/onboarding"; });
      el("chat-send").addEventListener("click", sendChat);
      el("chat-clear").addEventListener("click", () => { el("chat-question").value = ""; setNotice("chat-notice", "", ""); });
      el("chat-mode-button").addEventListener("click", (event) => {
        event.preventDefault();
        toggleModePanel();
      });
      document.querySelectorAll(".mode-option").forEach((node) => {
        node.addEventListener("click", () => applyModeSelection(node.getAttribute("data-mode") || "auto"));
      });
      document.addEventListener("click", (event) => {
        const wrap = document.querySelector(".mode-wrap");
        if (!wrap || wrap.contains(event.target)) return;
        closeModePanel();
      });
      el("intake-start").addEventListener("click", startIntakeConversation);
      el("intake-answer-send").addEventListener("click", sendIntakeAnswer);
      el("intake-complete").addEventListener("click", finalizeIntakeConversation);
      el("intake-refresh").addEventListener("click", loadIntakeStatus);
      el("ai-load").addEventListener("click", loadAiConfig);
      el("provider").addEventListener("change", loadModelOptions);
      el("api-key").addEventListener("input", () => { if (el("api-key").value.trim().length > 7) loadModelOptions(); });
      el("ai-save").addEventListener("click", saveAiConfig);
      el("password-save").addEventListener("click", changePassword);
      el("usage-refresh").addEventListener("click", loadUsage);
      el("menu-toggle").addEventListener("click", toggleDrawer);
      el("menu-close").addEventListener("click", closeDrawer);
      el("menu-overlay").addEventListener("click", closeDrawer);

      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          closeModePanel();
          closeDrawer();
          return;
        }
        if (event.key !== "Enter") return;
        const target = event.target;
        if (target && target.tagName === "TEXTAREA") {
          if (event.shiftKey) return;
          event.preventDefault();
          if (el("view-chat").classList.contains("active")) sendChat();
          if (el("view-intake").classList.contains("active")) sendIntakeAnswer();
          return;
        }
        if (event.shiftKey) return;
        if (el("view-chat").classList.contains("active")) {
          event.preventDefault();
          sendChat();
        }
      });

      async function init() {
        applyModeSelection("auto");
        await loadSession();
        await loadIntakeStatus();
        await loadAiConfig();
        if ((window.location.hash || "").toLowerCase() === "#intake") {
          showView("intake");
        }
      }
      init();
    </script>
  </body>
</html>



